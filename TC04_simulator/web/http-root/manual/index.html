<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
  <title>DewarServlet: System Overview</title>


  <link href="../Dewar.css" rel="stylesheet" type="text/css">

  <link rel="stylesheet" type="text/css" media="screen, projection" href="../menu.css">

</head>


<body>

<script type="text/javascript" src="../menu.js"></script><!-- Generated by Doxygen 1.4.2 -->
<ul id="menu-h" class="horizontal">

  <li><a class="el" href="index.html">Manual</a>
    <ul id="menu-h" class="horizontal">

      <li><a class="el" href="usage.html">Usage</a></li>

      <li><a class="el" href="props.html">Setup</a></li>

      <li><a class="el" href="problems.html">Problems</a></li>

      <li><a class="el" href="recycling.html">Scripts</a></li>

      <li><a class="el" href="calhelp.html">Calibration</a></li>

      <li><a class="el" href="pinouts.html">Pin-Outs</a></li>

    </ul>

  </li>

  <li><a class="el" href="/servlet/Dewar">Full</a></li>

  <li><a class="el" href="/servlet/Dewar&amp;type=brief">Brief</a></li>

  <li><a class="el" href="/servlet/LogViewer">Logs</a></li>

  <li><a class="el" href="../index.html">Root</a></li>

</ul>

<!-- Generated by Doxygen 1.4.2 -->
<div id="content">
<h1><a class="anchor" name="system">System
Overview</a></h1>

<h2><a class="anchor" name="outline">Outline</a></h2>

In this section we describe the Dewar thermal readout / control system.
<p>The purpose of the system is to read out temperatures from the
Dewar, and using these values, to adjust the voltages applied to
heaters on the fridge, etc, to perform fridge recycling. These values
are also logged to output files for graphing and later inspection, and
may be checked in real time using online client programs.</p>

<p>The main hardware components are:</p>

<ul>

  <li>The Dewar, containing the thermometers (diodes and RTDs)
and the heaters</li>

  <li>The readout electronics and heater amplifiers</li>

  <li>The conversion electronics, between analogue and digital
signals</li>

  <li>The control computer (SNAP)</li>

</ul>

<p>The Dewar contains conventional devices for thermometry and
heating. The diode thermometers are read out using a 10-&micro;A
bias current. The resulting voltage is digitized and read by the
computer. A module containing analogue switches has been provided, to
allow the diode drives to be shorted to ground. This is to prevent
heating of the cold stages due to the diode drive current, once the
stages are below the useful temperature range of diodes.</p>

<p>The RTDs are biased with a sinusoidal drive, with adjustable
frequency and phase. This is generated by one PIC microcontroller for
each RTD. A second PIC for each RTD provides control functions, such as
commanding the first PIC, and changing gains. The drive current,
in-phase and quadrature readout voltages are digitized and read by the
computer.</p>

<p>The heater drive is set by a digital-to-analogue converter.
This provides five heater channels, three of which have
computer-controlled current limits.</p>

<h2><a class="anchor" name="computer">Control
Computer</a></h2>

In a conventional system the computer would typically be a PC or
similar. Because of our original system constraints (driven by the need
to reduce power consumption and limit the size, originally for
operation at Chajnantor but also now for the South Pole) we chose to
employ an "embedded" computer. This was originally a <a href="http://www.maxim-ic.com/TINIplatform.cfm" target="_blank">"TINI"</a>
(Tiny INternet Interface).
<p>On later units (of which this is one) we are using a more-powerful
embedded computer, called <a href="http://www.imsys.se/" target="_blank">SNAP</a>. This uses are more
up-to-date flavour of Java - J2ME/CLDC.</p>

<p>Our system operates autonomously. For example, it can cycle
the fridge without any external intervention. As well as providing
simple input / output operations (i.e. thermometer readout and heater
drive) it provides for control of the RTD readout PICs.</p>

<h2><a class="anchor" name="comms">Communication
Interfaces</a></h2>

Fundamental to the operation of the system are the interfaces between
the control computer, other system components, and external devices.
<h3><a class="anchor" name="i2c">I2C</a></h3>

For chip-level communications (i.e. to the ADC, DAC chips, etc) we have
chosen the <a href="http://www.semiconductors.philips.com/buses/i2c/" target="_blank">I<sup>2</sup>C bus</a>.
This is a 2-wire serial bus, with a single master (the TINI/SNAP)
communicating with many slave ICs, each with its own slave address.
<p>A higher level bus architecture (e.g. one of the many "field"
buses) could have been chosen, but for communications within a single
rack unit a low-resource simple interface is more sensible.</p>

<p>The SNAP provides I<sup>2</sup>C
communications as standard.</p>

<p>The following devices are connected to the SNAP control
computer:</p>

<ul>

  <li>DACs (1 per heater module) to set heater voltages (and
current limits on the QUaD model)</li>

  <li>ADCs (1 per diode module) to read diode thermometer voltages</li>

  <li>Analogue switches (1 per diode module) to short unused
diode channels to ground</li>

  <li>ADCs (1 per RTD readout pair) to read RTD voltage,
quadrature voltage and current</li>

  <li>ADCs (1 per heater module, on Clover model only) to read
heater current</li>

  <li>PIOs (1 per heater module) to read heater status</li>

  <li>PICs (1 per RTD readout) to control RTD bias, range
selection, &amp;c</li>

</ul>

<p>
I<sup>2</sup>C paths are indicated in the figure by brown
lines.</p>

<h3><a class="anchor" name="lan">Network
Interface</a></h3>

For communication with the rest of the world we
have an ethernet interface. An RJ45 connector on the SNAP is
connected to a local area network (LAN) and thence to the
rest of the Internet .
<p>Communications sent through the LAN connexion are as follows:</p>

<ul>

  <li>Standard telnet sessions to control the operation of the
SNAP</li>

  <li>Standard FTP sessions, for updating the SNAP software and
fridge control scripts</li>

  <li>HTTP (Web browser) connexions to the Dewar Web pages</li>

  <li>"Owwl" TCP/IP connexions for reading back temperature data</li>

</ul>

<h3><a class="anchor" name="rs232">
RS232 Serial Port</a></h3>

The SNAP provide serial port connexions (both
logic-level and RS232 ports). One of these is connected through the
rear panel, and may be used for firmware updates. See the SNAP
documentation for instructions.


<h2><a class="anchor" name="dewarservlet">The
Dewar Servlet</a></h2>

<h3><a class="anchor" name="model">
The Software Model</a></h3>

The SNAP computer is programmed in Java. It therefore proved
convenient to provide for Dewar control / readout as a Java "servlet"
running under a Web server on the SNAP. The Web server is a
program called <a href="http://tynamo.qindesign.com/" target="_blank">"tynamo"</a>.
<p>The "Dewar" servlet is started automatically by tynamo, as
soon as it starts. Note that, currently, tynamo itself is not started
automatically - the user should start tynamo from a telnet session.</p>

<h3><a class="anchor" name="servlet">The
Dewar Servlet</a></h3>

The details of the Dewar servlet are given in the remainder of this
document. Briefly it consists of the following parts:
<p></p>

<ul>

  <li>The main servlet code, which initializes the system and
responds to http requests</li>

  <li>The "sensors looper" - this is a separate execution thread,
that continuously reads out all ADC values</li>

  <li>The "sensors server" - this is a separate execution thread,
that provides data to client programs using the "owwl" protocol</li>

  <li>The fridge recycler - Fed by thermometer data, this program
unit employs a "state machine" described by a user-provided script, to
adjust heater drive levels to achieve fridge recycling</li>

</ul>

<h3><a class="anchor" name="web">
Web Interface</a></h3>

The Dewar servlet running under the tynamo Web server serves several
Web pages to Web browser clients. These provide for various monitoring
and control functions. For example, one page shows the diode and RTD
values, another has a form to set heater values, and another allows the
fridge recycling state to be changed.
<p>Any standard Web browser can be used to access these pages,
firewall setup allowing. However, because of the limited resources of
the SNAP it is not desireable that members not closely involved in
this aspect of operation should access the SNAP directly.</p>

<h2><a class="anchor" name="owwl">Owwl
Interface</a></h2>

To achieve a much higher data throughput than proved possible with
http, a binary data protocol was implemented on the SNAP. This was
developed from some earlier work, and for historical reasons is called
"Owwl". A C library for receiving or sending with the owwl protocol is <a href="http://cvs.sourceforge.net/viewcvs.py/oww/owwl/" target="_blank">available</a>. Documentation is
provided <a href="http://oww.sourceforge.net/owwl_docs/index.html" target="_blank">here</a>
<h3><a class="anchor" name="owwclient">Oww
Client</a></h3>

Also deriving from earlier work, there is a client program for the owwl
protocol - Oww Client. This can be built on Windows and Linux, and
provides a window showing tabulated live data from the owwl server
(i.e. the SNAP). Oww Client may be download from <a href="https://sourceforge.net/project/showfiles.php?group_id=86628&amp;package_id=99638" target="_blank">Sourceforge</a>.
<h3><a class="anchor" name="owwlog">owwlog</a></h3>

To provide for logging of thermometry data during the Dewar development
phase, I have written owwlog. This is another program derived from the
owwl library. It may be compiled for Windows or Linux.
<p>Owwlog has the following main features:</p>

<p></p>

<ul>

  <li>Log integrated thermometry data to log files (text format)</li>

  <li>May use calibration data to provide diode and RTD
temperature data</li>

  <li>May maintain a round-robin database (RRD)</li>

  <li>May re-broadcast data, taking the strain off the SNAP,
with calibrated data added</li>

</ul>

<p>
There is a page describing owwlog at <a href="http://quest2.astro.cf.ac.uk/quest/sjm/Owwlog/index.html" target="_blank">Cardiff</a>, and a public version on <a href="http://oww.sourceforge.net/owwlog.html" target="_blank">Sourceforge</a>.</p>

<p>Owwlog is a temporary measure, whilst the owwl extension of
the DASI software is developed - see below.</p>

<p>Note that users wishing to view thermometry data with Oww
Client may benefit from the addition of calibrated data channels, and
reduce the load on the SNAP, by connecting Oww Client to the
instance of owwlog re-broadcasting data from quest1.</p>


<h3><a class="anchor" name="dasi">DASI
Software</a></h3>

The owwl library has also been compiled with VXWorks - the operating
system used by the DASI VME computers. It is being integrated into the
DASI software system, and will allow embedding of Dewar readout data
within the main data stream. This will also allow DASI clients to view
plots of thermometry data.
<p>The elements intended for Polar operation are indicated on the
system schematic in blue. These will replace the elements for
lab'-based operation, shown in pink.</p>

<h2><a class="anchor" name="recyclingcont">Recycling
Control</a></h2>

Thus far we have focused on the thermometry readout functions. The
system is also responsible for autonomous cycling of the three-stage
helium fridge.
<p>The servlet now provides a fully flexible mechanism for
controlling recycling operations, using a state machine to describe the
various stages of the process. The form of the state machine is
described by an xml file, tailored to our fridge. The format of this
file is described in detail on the <a class="el" href="recycling.html">Fridge Recycling</a> page. This
file is copied to the SNAP using FTP. If the file is updated, it
may be re-loaded into the servlet by clicking the "Reload XML" button
on the recycling page.</p>

<p>Although the recycling process operates autonomously, it is
desireable to coordinate when it is started, with the main DASI control
system. Then we can monitor the cryogenic temperatures, and when they
are becoming critical we can pick a suitable opportunity to start
recycling the fridge.</p>

<p>Therefore we need an "upstream" communication channel from the
DASI computer to the SNAP, in addition to the "downstream"
connexion provided by the owwl protocol. This may be achieved simply by
instructing a fridge state change encoded in a URL, the same as would
be sent by a user clicking on the form submit button of the fridge
recycling page. A suitable http library is being built into the DASI
software. </p>

</div>

</body>
</html>
