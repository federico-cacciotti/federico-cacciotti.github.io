<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
  <title>DewarServlet: Fridge Recycling Scripts</title>


  <link href="../Dewar.css" rel="stylesheet" type="text/css">

  <link rel="stylesheet" type="text/css" media="screen, projection" href="../menu.css">

</head>


<body>

<script type="text/javascript" src="../menu.js"></script><!-- Generated by Doxygen 1.4.2 -->
<ul id="menu-h" class="horizontal">

  <li><a class="el" href="index.html">Manual</a>
    <ul id="menu-h" class="horizontal">

      <li><a class="el" href="usage.html">Usage</a></li>

      <li><a class="el" href="props.html">Setup</a></li>

      <li><a class="el" href="problems.html">Problems</a></li>

      <li><a class="el" href="recycling.html">Scripts</a></li>

      <li><a class="el" href="calhelp.html">Calibration</a></li>

      <li><a class="el" href="pinouts.html">Pin-Outs</a></li>

    </ul>

  </li>

  <li><a class="el" href="/servlet/Dewar">Full</a></li>

  <li><a class="el" href="/servlet/Dewar&amp;type=brief">Brief</a></li>

  <li><a class="el" href="/servlet/LogViewer">Logs</a></li>

  <li><a class="el" href="../index.html">Root</a></li>

</ul>

<!-- Generated by Doxygen 1.4.2 -->
<div id="content">
<h1><a class="anchor" name="recycling">Fridge
Recycling Scripts</a></h1>

<h2><a class="anchor" name="manual">Manual
Control</a></h2>

The ``Helium10'' fridge is controlled by the SNAP system, through
its digital-to-analogue outputs, controlling the fridge heaters and
heat switches. The drive levels may be set manually through the Web
interface:
<p><a href="tini03/servlet/Dewar?type=printdacs">tini03/servlet/Dewar?type=printdacs</a></p>

<p></p>

<div align="center"><iframe src="printdacs.html" height="400" scrolling="no" width="500"></iframe></div>

<h3><a class="anchor" name="manualurl">Manual
Computer Control</a></h3>

Should you want to take control of the heater drives from another
computer, you may arrange for appropriate URLs to be fetched from the
SNAP, simulating user input to the heater control form.
<p>The normal method of form submission is HTTP POST. This means
the parameter information is not visible in the URL. However, the
servlet will also take parameters passed through the URL with HTTP GET.</p>

<p>The parameter used to control heater 1, for example, is SET1,
and SET2 for heater 2, &amp;c.</p>

<p>These parameters should be appended to the normal URL, with <code></code>?type=setdacs
For example:</p>

<p><a href="http://snap01/servlet/Dewar?type=setdacs&amp;SET1=2.5&amp;SET2=3.5">http://snap01/servlet/Dewar?type=setdacs&amp;SET1=2.5&amp;SET2=3.5</a></p>



<p>To fetch these URLs programatically (e.g. from LabView) you
could use, for example, curl (<a href="http://curl.haxx.se/download/curl-7.15.0-win32-nossl-sspi.zip">http://curl.haxx.se/download/curl-7.15.0-win32-nossl-sspi.zip</a>)</p>

<p></p>

<div align="center"></div>

<div class="fragment">
<pre class="fragment">curl <span class="stringliteral">"http://RTDuser:RTDpass@snap01/servlet/Dewar?type=setdacs&amp;SET1=2.5&amp;SET2=3.5"</span>
</pre>

</div>

<h2><a class="anchor" name="auto">Automatic
Fridge Cycling</a></h2>

Alternatively, they may be controlled by the automatic fridge cycling
system:
<p><a href="tini03/servlet/Dewar?type=recycle">tini03/servlet/Dewar?type=recycle</a></p>

<p></p>

<div align="center">
<div align="center"><iframe src="recycle.html" height="300" scrolling="no" width="500"></iframe></div>

<br>

</div>

This Web page allows the user to select from a number of different
fridge states. As a state is selected, the servlet will perform various
defined actions, such as setting heater values. Then, after every
1-second update of the Dewar readout, tests may be performed for
various conditions, and if met, another state will be assumed.
<h3><a class="anchor" name="xml">XML File</a></h3>

The actions and tests are defined in a control file on the TINI/SNAP: <code>Dewar.xml</code>
<p>This file is written in <code>xml</code> and
specifies all
of the available <em>states</em>. You may think of this as
defining a <em>state machine</em> for the control process.
If you prefer, you may think of each state as a program step.</p>

<p>Below is a very simple example file:</p>

<p></p>

<div class="fragment">
<pre class="fragment">&lt;?xml version="1.0"?&gt;<br><br>&lt;!-- Trial Dewar definition - Simon Melhuish --&gt;<br>&lt;dewar&gt;<br> &lt;defaultstate&gt;idle&lt;/defaultstate&gt;<br> &lt;state name="idle"&gt;<br> &lt;actions&gt;<br> &lt;message&gt;Idle&lt;/message&gt;<br> &lt;/actions&gt;<br> &lt;!-- This is the idle state. Do nothing. Wait for nothing. --&gt;<br> &lt;/state&gt;<br> <br> &lt;state name="HS4on"&gt;<br> &lt;actions&gt;<br> &lt;message&gt;HS4on&lt;/message&gt;<br> &lt;!-- Heater 5 is 4He HS --&gt;<br> &lt;heater chan="5" V="3.0"/&gt;<br> &lt;/actions&gt;<br> &lt;tests&gt;<br> &lt;!-- Run for 2 minutes --&gt;<br> &lt;if goto="HS4off"&gt;<br> &lt;timeout time="120" since="HS4on"/&gt;<br> &lt;/if&gt;<br> &lt;/tests&gt;<br> &lt;/state&gt;<br> <br> &lt;state name="HS4off"&gt;<br> &lt;actions&gt;<br> &lt;message&gt;HS4off&lt;/message&gt;<br> &lt;!-- Heater 5 is 4He HS --&gt;<br> &lt;heater chan="5" V="0.0"/&gt;<br> &lt;/actions&gt;<br> &lt;tests&gt;<br> &lt;!-- Run for 2 minutes --&gt;<br> &lt;if goto="HS4on"&gt;<br> &lt;timeout time="120" since="HS4off"/&gt;<br> &lt;/if&gt;<br> &lt;/tests&gt;<br> &lt;/state&gt;<br>&lt;/dewar&gt;<br></pre>

</div>

<p>This defines three states:</p>

<p></p>

<ul>

  <li><code>idle</code> </li>

  <li><code>HS4on</code> </li>

  <li><code>HS4off</code> </li>

</ul>

The <code>idle</code> state does nothing, <code>HS4on</code>
switches on a heater, and <code>HS4off</code> switches it
off. <code>HS4on</code> and <code>HS4off</code>
use a 2-minute timer to jump between each other.
<p>Let's look at the code in detail:</p>

<p></p>

<div class="fragment">
<pre class="fragment"> &lt;?xml version="1.0"?&gt;</pre>

</div>

<p>This says that the file is written in xml.</p>

<p></p>

<div class="fragment">
<pre class="fragment"> &lt;!-- Trial Dewar definition - Simon Melhuish --&gt;</pre>

</div>

<p>This is a comment line. You may use this style to enter
comments within the xml. It is very useful to do this.</p>

<p>All of the state definitions must be enclosed within a pair of
<code>dewar</code> tags.</p>

<p></p>

<div class="fragment">
<pre class="fragment">&lt;dewar&gt;<br> &lt;defaultstate&gt;idle&lt;/defaultstate&gt;<br> ...<br>&lt;/dewar&gt;<br></pre>

</div>

<p>The <code>defaultstate</code> tag specifies the
state to be selected by the state machine once the definition file has
finished loading. On first entry to the <code>recycle</code>
Web page, it will be seen that this state has been entered.</p>

<p></p>

<div class="fragment">
<pre class="fragment"> &lt;state name="idle"&gt;<br> &lt;actions&gt;<br> &lt;message&gt;Idle&lt;/message&gt;<br> &lt;/actions&gt;<br> &lt;!-- This is the idle state. Do nothing. Wait for nothing. --&gt;<br> &lt;/state&gt;<br></pre>

</div>

<p>This is a very simple state definition, using the <code>state</code>
tag. Note that a state requires that you give it a name. This name is
used by all subsequent references to the state, and in the Web page.</p>

<p>This state defines one action to be performed, using an <code>actions</code>
block. The action is to output a message to the Web page, and to the
LCD (if fitted).</p>

<p>The next state definition adds another action and a <code>tests</code>
block:</p>

<p></p>

<div class="fragment">
<pre class="fragment"> &lt;state name="HS4on"&gt;<br> &lt;actions&gt;<br> &lt;message&gt;HS4on&lt;/message&gt;<br> &lt;!-- Heater 5 is 4He HS --&gt;<br> &lt;heater chan="5" V="3.0"/&gt;<br> &lt;/actions&gt;<br> &lt;tests&gt;<br> &lt;!-- Run for 2 minutes --&gt;<br> &lt;if goto="HS4off"&gt;<br> &lt;timeout time="120" since="HS4on"/&gt;<br> &lt;/if&gt;<br> &lt;/tests&gt;<br> &lt;/state&gt;<br></pre>

</div>

<p>The new action is given by the <code>heater</code>
tag. It sets heater channel 5 to 3.0 V. The other channels are left
unchanged. You may also specify a current limit (for hardware channels
that have it) using an optional <code>I</code> attribute.</p>

<p>The <code>tests</code> block may contain any
number of <code>if</code> tag pairs. These comprise tests
to be carried out, and the state to enter (given by the <code>goto</code>
attribute) in the event that a test returns <em>true</em>.
In this case there is a single <code>timeout</code> test.
There may be more tests between the opening and closing <code>if</code>
tags, in which case there is an implicit <code>or</code>
of the results, i.e. each test is tried in turn, and as soon as any
returns <em>true</em> the state machine jumps to the <code>goto</code>
state.</p>

<p>The full list of possible tests is as follows:</p>

<p></p>

<dl>

  <dt><code>&lt;timeout time="999"
since="state"/&gt;</code> </dt>

  <dd>Return <em>true</em> if <code>time</code>
seconds have passed since state <code>state</code> was
entered. </dd>

  <dt><code>&lt;value source="vdiode" chan="3"
greaterthan="1.29"/&gt;</code> </dt>

  <dd>Return <em>true</em> if the channel <code>chan</code>
diode voltage is greater than <code>greaterthan</code>
Volts. The <em>source</em> attribute may be:
    <ul>

      <li>vdiode</li>

      <li>rrtd</li>

      <li>tdiode</li>

      <li>trtd The temperature sources will only work for sensors
with an associated calibration (and SNAP only). You may also use a <code>lessthan</code>
attribute. You may specify the number of samples to smooth over with <code>samples</code>
      </li>

    </ul>

  </dd>

  <dt><code>&lt;valueot source="vdiode" chan="3"
lessthan="-1.0"/&gt;</code> </dt>

  <dd>Return <em>true</em> if the channel <code>chan</code>
diode voltage time derivative is less than <code>lessthan</code>
Volts/s. The <em>source</em> attribute may be:
    <ul>

      <li>vdiode</li>

      <li>rrtd</li>

      <li>tdiode</li>

      <li>trtd The temperature sources will only work for sensors
with an associated calibration (and SNAP only). You may also use a <code>greathan</code>
attribute. You may specify the number of samples to regress over with <code>samples</code>
      </li>

    </ul>

  </dd>

  <dt><code>&lt;or&gt;&lt;/or&gt;</code>
  </dt>

  <dd>Returns the boolean <em>or</em> of tests
placed between the opening and closing tags. </dd>

  <dt><code>&lt;and&gt;&lt;/and&gt;</code>
  </dt>

  <dd>Returns the boolean <em>and</em> of tests
placed between the opening and closing tags. </dd>

  <dt><code>&lt;pid id="pid1" p="1.0" i ="1.0" d="1.0"
sp="20.0" source="tdiode" chan="1" heater="5"/&gt;</code> </dt>

  <dd>Start a PID control with the given PID values and set
point. Determining appropriate PID values is up to the user. The <em>source</em>
attribute may be:
    <ul>

      <li>vdiode</li>

      <li>rrtd</li>

      <li>tdiode</li>

      <li>trtd The temperature sources will only work for sensors
with an associated calibration (and SNAP only). </li>

    </ul>

  </dd>

</dl>

<p>
</p>

<ul>

  <li>id The name of this PID control</li>

  <li>p The P (proportional) value</li>

  <li>i The I (integral) value</li>

  <li>d The D (derivative) value</li>

  <li>sp The set point</li>

  <li>source - the source type. One of:</li>

</ul>

<p>
Here are some reminders of basic rules for writing xml:</p>

<p></p>

<ol>

  <li>Don't forget the standard start line: <code>&lt;?xml
version="1.0"?&gt;</code> </li>

  <li>The top level element must be <code>dewar</code>,
i.e.
everything else must be within <code>&lt;dewar&gt;&lt;/dewar&gt;</code>
tags </li>

  <li>Tags come either in pairs containing child tags, or singly,
just with
attributes, e.g.
    <ul>

      <li> <code>&lt;state
name="statename"&gt;&lt;/state&gt;</code> </li>

      <li> <code>&lt;heater chan="5" V="3.0"/&gt;</code>
- note the closing / character</li>

    </ul>

  </li>

  <li>Add useful comments </li>

</ol>

<p>
When your xml file is ready, upload it to the TINI/SNAP by FTP. It
should be <code>/web/bin/Dewar.xml</code> You may reload
the state machine with fresh definitions by clicking the "Reload xml"
button. Note that it currently takes a while for the file to be parsed.</p>

<h3><a class="anchor" name="xmldtd">XML DTD</a></h3>

The official description of an xml dialect is given by a Document
Template Description (DTD) file. Here is one I wrote for the Dewar
files:
<p></p>

<div class="fragment">
<pre class="fragment">&lt;!ELEMENT dewar (defaultstate,state+)&gt;<br>&lt;!ELEMENT defaultstate (#PCDATA)&gt;<br><br>&lt;!ELEMENT state (actions*,tests*)&gt;<br>&lt;!ATTLIST state name CDATA #REQUIRED&gt;<br><br>&lt;!ELEMENT actions (heater*,message*,diodeswitch*)&gt;<br><br>&lt;!ELEMENT heater EMPTY&gt;<br>&lt;!ATTLIST heater chan CDATA #REQUIRED&gt;<br>&lt;!ATTLIST heater V CDATA #REQUIRED&gt;<br>&lt;!ATTLIST heater I CDATA #IMPLIED&gt;<br><br>&lt;!ELEMENT message (#PCDATA)&gt;<br><br>&lt;!ELEMENT diodeswitch EMPTY&gt;<br>&lt;!ATTLIST diodeswitch chan CDATA #IMPLIED&gt;<br>&lt;!ATTLIST diodeswitch state CDATA #REQUIRED&gt;<br><br>&lt;!ELEMENT tests (if+)&gt;<br><br>&lt;!ELEMENT if (timeout*,diode*,diodedot*,grt*,grtdot*)&gt;<br>&lt;!ATTLIST if goto CDATA #REQUIRED&gt;<br><br>&lt;!ELEMENT timeout EMPTY&gt;<br>&lt;!ATTLIST timeout time CDATA #REQUIRED&gt;<br>&lt;!ATTLIST timeout since CDATA #REQUIRED&gt;<br><br>&lt;!ELEMENT pid EMPTY&gt;<br>&lt;!ATTLIST pid id CDATA #REQUIRED&gt;<br>&lt;!ATTLIST pid p CDATA #IMPLIED&gt;<br>&lt;!ATTLIST pid i CDATA #IMPLIED&gt;<br>&lt;!ATTLIST pid i CDATA #IMPLIED&gt;<br>&lt;!ATTLIST pid sp CDATA #REQUIRED&gt;<br>&lt;!ATTLIST pid source CDATA #REQUIRED&gt;<br><br>&lt;!ELEMENT value EMPTY&gt;<br>&lt;!ATTLIST value chan CDATA #REQUIRED&gt;<br>&lt;!ATTLIST value lessthan CDATA #IMPLIED&gt;<br>&lt;!ATTLIST value greaterthan CDATA #IMPLIED&gt;<br>&lt;!ATTLIST value samples CDATA #IMPLIED&gt;<br>&lt;!ATTLIST value source CDATA #REQUIRED&gt;<br><br>&lt;!ELEMENT valuedot EMPTY&gt;<br>&lt;!ATTLIST valuedot chan CDATA #REQUIRED&gt;<br>&lt;!ATTLIST valuedot lessthan CDATA #IMPLIED&gt;<br>&lt;!ATTLIST valuedot greaterthan CDATA #IMPLIED&gt;<br>&lt;!ATTLIST valuedot samples CDATA #IMPLIED&gt;<br>&lt;!ATTLIST valuedot source CDATA #REQUIRED&gt;<br><br>&lt;!ELEMENT diode EMPTY&gt;<br>&lt;!ATTLIST diode chan CDATA #REQUIRED&gt;<br>&lt;!ATTLIST diode lessthan CDATA #IMPLIED&gt;<br>&lt;!ATTLIST diode greaterthan CDATA #IMPLIED&gt;<br>&lt;!ATTLIST diode samples CDATA #IMPLIED&gt;<br><br>&lt;!ELEMENT diodedot EMPTY&gt;<br>&lt;!ATTLIST diodedot chan CDATA #REQUIRED&gt;<br>&lt;!ATTLIST diodedot lessthan CDATA #IMPLIED&gt;<br>&lt;!ATTLIST diodedot greaterthan CDATA #IMPLIED&gt;<br>&lt;!ATTLIST diodedot samples CDATA #IMPLIED&gt;<br><br>&lt;!ELEMENT grt EMPTY&gt;<br>&lt;!ATTLIST grt chan CDATA #REQUIRED&gt;<br>&lt;!ATTLIST grt lessthan CDATA #IMPLIED&gt;<br>&lt;!ATTLIST grt greaterthan CDATA #IMPLIED&gt;<br>&lt;!ATTLIST grt samples CDATA #IMPLIED&gt;<br><br>&lt;!ELEMENT grtdot EMPTY&gt;<br>&lt;!ATTLIST grtdot chan CDATA #REQUIRED&gt;<br>&lt;!ATTLIST grtdot lessthan CDATA #IMPLIED&gt;<br>&lt;!ATTLIST grtdot greaterthan CDATA #IMPLIED&gt;<br>&lt;!ATTLIST grtdot samples CDATA #IMPLIED&gt;<br><br></pre>

</div>

</div>

</body